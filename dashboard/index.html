<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTB Live Leaderboard</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            /* GitHub Dark / HTB Darkish */
            color: #e6edf3;
            overflow-x: hidden;
        }

        .htb-green {
            color: #9fef00;
        }

        .bg-htb-green {
            background-color: #9fef00;
        }

        .border-htb-green {
            border-color: #9fef00;
        }

        .shadow-neon {
            box-shadow: 0 0 10px rgba(159, 239, 0, 0.3);
        }

        /* Animation Classes */
        .player-row {
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
        }

        .crown-icon {
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .feed-item {
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #161b22;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9fef00;
        }

        /* Modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
    </style>
</head>

<body class="h-screen flex flex-col p-6">

    <!-- Header -->
    <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-800">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-htb-green rounded flex items-center justify-center text-black font-bold text-xl">H
            </div>
            <h1 class="text-3xl font-bold tracking-tight text-white">Live <span class="htb-green">Ops</span> Dashboard
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-4 bg-gray-800/50 px-4 py-2 rounded-lg border border-gray-700">
                <i data-lucide="server" class="w-4 h-4 text-gray-400"></i>
                <span class="text-sm text-gray-400">HOST ID:</span>
                <code id="host-id" class="text-htb-green font-bold select-all cursor-pointer">Initializing...</code>
            </div>
            <button onclick="toggleSettings()"
                class="p-2 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 grid grid-cols-12 gap-6 h-full overflow-hidden">

        <!-- Left: Leaderboard (8 cols) -->
        <div class="col-span-12 lg:col-span-8 flex flex-col">
            <div class="flex justify-between text-xs text-gray-500 uppercase tracking-wider mb-2 px-4">
                <span>Rank / Hacker</span>
                <span>Mission Progress</span>
            </div>

            <!-- Relative container for absolute positioning of rows -->
            <div id="leaderboard-container"
                class="relative flex-1 bg-gray-900/50 rounded-xl border border-gray-800 overflow-y-auto overflow-x-hidden">
                <!-- Rows injected here via JS -->
                <div
                    class="absolute inset-0 flex items-center justify-center text-gray-600 opacity-20 pointer-events-none sticky top-0 h-full">
                    <i data-lucide="crosshair" class="w-64 h-64"></i>
                </div>
            </div>
        </div>

        <!-- Right: Activity Feed (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 flex flex-col bg-gray-900 rounded-xl border border-gray-800 h-full overflow-hidden">
            <div class="p-4 border-b border-gray-800 bg-gray-900/80 backdrop-blur z-10">
                <h2 class="text-sm font-bold text-gray-300 flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-htb-green"></i> Live Feed
                </h2>
            </div>
            <div id="feed-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Feed Items injected here -->
            </div>
        </div>

    </main>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="modal hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i> Settings
                </h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Host Peer ID</label>
                    <input type="text" id="setting-host-id"
                        class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white focus:border-htb-green focus:outline-none font-mono"
                        placeholder="Enter Host ID">
                    <p class="text-xs text-gray-500 mt-1">This dashboard will listen for data on this ID.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Username Mappings</label>
                    <textarea id="setting-user-map" rows="6"
                        class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white focus:border-htb-green focus:outline-none font-mono text-sm"
                        placeholder="HTBUsername Real Name&#10;CoolHacker John Doe"></textarea>
                    <p class="text-xs text-gray-500 mt-1">One mapping per line. Replaces HTB username with Real Name in
                        leaderboard.</p>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
                    <button onclick="toggleSettings()" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button onclick="saveSettings()"
                        class="px-6 py-2 bg-htb-green text-black font-bold rounded hover:bg-opacity-90">Save &
                        Reload</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const DEFAULT_HOST_ID = 'htb-dashboard-listener-12345';
        const ROW_HEIGHT = 88; // Height of player card + margin in pixels

        // Load Settings
        let HOST_ID_KEY = localStorage.getItem('htb_host_id') || DEFAULT_HOST_ID;
        let USER_MAP = {};

        function loadUserMap() {
            const mapStr = localStorage.getItem('htb_user_map') || '';
            const map = {};
            mapStr.split('\n').forEach(line => {
                const parts = line.trim().split(/\s+(.+)/); // Split on first whitespace
                if (parts.length >= 2) {
                    map[parts[0]] = parts[1];
                }
            });
            return map;
        }
        USER_MAP = loadUserMap();

        // --- State ---
        const players = {}; // Map: username -> data object
        const feedEvents = [];
        let peer = null;

        // --- Init Lucide Icons ---
        lucide.createIcons();

        // --- UI Functions ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isHidden = modal.classList.contains('hidden');

            if (isHidden) {
                // Populate fields
                document.getElementById('setting-host-id').value = HOST_ID_KEY;
                document.getElementById('setting-user-map').value = localStorage.getItem('htb_user_map') || '';
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function saveSettings() {
            const newHostId = document.getElementById('setting-host-id').value.trim();
            const newMap = document.getElementById('setting-user-map').value.trim();

            if (newHostId) {
                localStorage.setItem('htb_host_id', newHostId);
            }
            localStorage.setItem('htb_user_map', newMap);

            window.location.reload();
        }

        // --- PeerJS Setup ---
        peer = new Peer(HOST_ID_KEY);

        peer.on('open', (id) => {
            document.getElementById('host-id').innerText = id;
            addFeedItem('System', 'Dashboard Online. Waiting for agents...', 'system');
        });

        // Resilience Logic: Auto-reconnect if signaling server drops
        peer.on('disconnected', () => {
            addFeedItem('System', 'Signal lost. Attempting reconnect...', 'system');
            console.log('Peer disconnected from server. Reconnecting...');
            peer.reconnect();
        });

        peer.on('error', (err) => {
            console.error('Peer error:', err);
            if (err.type === 'unavailable-id') {
                addFeedItem('System', `Error: ID '${HOST_ID_KEY}' is taken. Change it in settings.`, 'system');
            } else {
                // Ignore minor network errors, but log them
                if (err.type !== 'peer-unavailable') {
                    addFeedItem('System', `Network Warning: ${err.type}`, 'system');
                }
            }
        });

        peer.on('connection', (conn) => {
            conn.on('data', (msg) => {
                if (msg.type === 'UPDATE') {
                    handleUpdate(msg.payload);
                } else if (msg.type === 'HEARTBEAT') {
                    handleHeartbeat(msg.payload);
                }
            });
            conn.on('open', () => {
                // Connection established log (optional)
            });
        });

        // --- Logic ---

        function getDisplayName(username) {
            return USER_MAP[username] || username;
        }

        function handleUpdate(data) {
            const { username, progress, machine } = data;
            const displayName = getDisplayName(username);

            // Check for new solves to populate feed
            if (players[username]) {
                const oldSolved = players[username].progress.solvedTaskNames || [];
                const newSolved = progress.solvedTaskNames || [];

                // Find difference
                newSolved.forEach(task => {
                    if (!oldSolved.includes(task)) {
                        addFeedItem(displayName, `captured flag: ${task}`, 'success');
                    }
                });
            } else {
                addFeedItem(displayName, `joined the operation on ${machine}`, 'info');
            }

            // Update State
            players[username] = {
                ...data,
                lastSeen: Date.now()
            };

            renderLeaderboard();
        }

        function handleHeartbeat(payload) {
            if (players[payload.username]) {
                players[payload.username].lastSeen = Date.now();
            }
        }

        function addFeedItem(user, action, type) {
            const container = document.getElementById('feed-container');
            const item = document.createElement('div');
            item.className = 'feed-item flex gap-3 text-sm p-3 rounded bg-gray-800/40 border border-gray-700/50';

            let iconColor = 'text-gray-400';
            let iconName = 'info';

            if (type === 'success') { iconColor = 'text-htb-green'; iconName = 'flag'; }
            if (type === 'system') { iconColor = 'text-blue-400'; iconName = 'terminal'; }

            item.innerHTML = `
                <div class="mt-0.5"><i data-lucide="${iconName}" class="w-4 h-4 ${iconColor}"></i></div>
                <div>
                    <span class="font-bold text-gray-200">${user}</span> 
                    <span class="text-gray-400">${action}</span>
                    <div class="text-[10px] text-gray-600 mt-1 font-mono">${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            container.insertBefore(item, container.firstChild);

            // Cleanup old items
            if (container.children.length > 50) {
                container.lastChild.remove();
            }
            lucide.createIcons();
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-container');

            // 1. Sort Players
            // Criteria: Percentage DESC, then Completed Count DESC, then Last Updated DESC
            const sortedUsers = Object.keys(players).sort((a, b) => {
                const pA = players[a].progress;
                const pB = players[b].progress;

                if (pA.percentage !== pB.percentage) return pB.percentage - pA.percentage;
                if (pA.completed !== pB.completed) return pB.completed - pA.completed;
                return players[b].timestamp - players[a].timestamp;
            });

            // 2. Render or Update Rows
            sortedUsers.forEach((user, index) => {
                let row = document.getElementById(`player-row-${user}`);
                const pData = players[user];
                const displayName = getDisplayName(user);
                const isFirst = index === 0;

                // Position calculation
                const topPos = index * ROW_HEIGHT + 16; // 16px padding top

                // HTML Content
                const innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${isFirst ? 'bg-yellow-400' : (index < 3 ? 'bg-gray-400' : 'bg-gray-700')} rounded-l"></div>
                    <div class="p-4 pl-6 flex items-center gap-4 w-full h-full">
                        
                        <!-- Rank -->
                        <div class="flex-shrink-0 w-8 text-center">
                            ${isFirst
                        ? `<i data-lucide="crown" class="w-6 h-6 text-yellow-400 crown-icon mx-auto"></i>`
                        : `<span class="text-xl font-bold text-gray-500">#${index + 1}</span>`
                    }
                        </div>

                        <!-- Avatar/Name -->
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded bg-gray-700 flex items-center justify-center font-bold text-lg text-white border ${isFirst ? 'border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.3)]' : 'border-gray-600'}">
                                ${displayName.charAt(0).toUpperCase()}
                            </div>
                        </div>

                        <!-- Info -->
                        <div class="flex-grow min-w-0">
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-lg truncate ${isFirst ? 'text-yellow-400' : 'text-white'}">${displayName}</h3>
                                ${Date.now() - pData.lastSeen < 10000
                        ? '<span class="w-2 h-2 rounded-full bg-htb-green animate-pulse" title="Live"></span>'
                        : ''
                    }
                            </div>
                            <div class="text-xs text-gray-400 truncate flex items-center gap-1">
                                <i data-lucide="monitor" class="w-3 h-3"></i> ${pData.machine}
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="flex-shrink-0 text-right w-48">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="${isFirst ? 'text-yellow-400' : 'text-htb-green'} font-bold">${pData.progress.percentage}%</span>
                                <span class="text-gray-500 text-xs">${pData.progress.completed}/${pData.progress.total} Tasks</span>
                            </div>
                            <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full ${isFirst ? 'bg-yellow-400' : 'bg-htb-green'} transition-all duration-500" style="width: ${pData.progress.percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;

                if (!row) {
                    row = document.createElement('div');
                    row.id = `player-row-${user}`;
                    row.className = `player-row h-20 bg-gray-800 rounded border border-gray-700 mx-4 shadow-lg ${isFirst ? 'border-yellow-400/50 bg-gray-800/80' : ''}`;
                    row.innerHTML = innerHTML;
                    row.style.marginLeft = "1rem";
                    row.style.width = "calc(100% - 2rem)";
                    container.appendChild(row);
                } else {
                    // Update visual state if rank changed or score updated
                    row.innerHTML = innerHTML;
                    // Toggle Gold Border class based on rank
                    if (isFirst) {
                        row.classList.add('border-yellow-400/50');
                        row.classList.remove('border-gray-700');
                    } else {
                        row.classList.remove('border-yellow-400/50');
                        row.classList.add('border-gray-700');
                    }
                }

                // Apply Position (Animation happens via CSS transition on transform)
                row.style.transform = `translateY(${topPos}px)`;

            });

            // 3. FORCE SCROLL HEIGHT (The Fix)
            // Since elements are absolute, they don't push the container's scrollbar. 
            // We insert a transparent spacer div to force the container to have the correct scrollable height.
            const totalHeight = sortedUsers.length * ROW_HEIGHT + 32; // 32px for bottom padding
            let spacer = document.getElementById('leaderboard-spacer');
            if (!spacer) {
                spacer = document.createElement('div');
                spacer.id = 'leaderboard-spacer';
                spacer.style.position = 'absolute';
                spacer.style.top = '0';
                spacer.style.left = '0';
                spacer.style.width = '1px';
                spacer.style.zIndex = '-1';
                spacer.style.pointerEvents = 'none';
                container.appendChild(spacer);
            }
            spacer.style.height = `${totalHeight}px`;

            // Re-init icons for new elements
            lucide.createIcons();
        }

        // Live status checker loop
        setInterval(() => {
            renderLeaderboard(); // Re-render to update "Live" status dot or resort if heartbeat timestamps affect tie-breaking
        }, 5000);

    </script>
</body>

</html>